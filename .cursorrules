# Barchart Library - Copilot Guidance

## Features & Visual Requirements

- **Tooltip Activation on Vertical Hover**: Tooltip appears when hovering anywhere along a bar's vertical axis, not just directly over the bar.
- **Highlight Hovered Bar**: Show a circle at the top (or average for high-low), minimal height for zero-height bars, and a vertical highlight line.
- **Sticky Centered Chart Title**: Title remains centered and sticky during horizontal scroll.
- **Customizable Tooltip Content**: Tooltip content is user-configurable via function/template.
- **Tooltip Positioning in Multi-Chart**: Tooltip always appears next to the mouse, never obscuring chart content.
- **Multiple Chart Types with Shared X-Axis**: Support for vertically stacked charts, each with its own y-axis, sharing a synchronized x-axis.
- **Per-Chart Data Sets in Multi-Chart**: Each chart in a multi-chart config can specify its own `data` array. All charts share the same x-axis domain (number and order of records), but each chart's values are sourced from its own data set. Data arrays must be aligned by x-axis key (e.g., date), and have the same length/order.
- **Minimal Gap and Bottom Alignment**: Minimal gap (5–10px) between y-axis and chart; chart is bottom-aligned above x-axis.
- **Smooth Scrolling**: Horizontal scrolling is smooth and responsive.
- **Quarter Labels for Week-Based Y-Axis**: Week-based charts show both week and quarter/year labels, with visual boundaries.
- **Horizontal Scrolling with Sticky Y-Axis**: Y-axis remains sticky with a drop shadow only when content is scrollable.
- **Nice Y-Axis Tick Values**: Linear y-axis ticks use "nice" numbers (1, 2, 5, 10, etc.) for max value.
- **Configurable Y-Axis Logarithmic Scale and Number Formatting**: Log10 y-axis option, with user-configurable number formatting (K/M/B, thousand separators).
- **Dynamic Intermediate Grid Lines for Log Scale**: Log10 scale draws intermediate grid lines/ticks based on interval position, with more detail at the bottom.

---

## Axis & Rendering Logic

- Data is grouped and labeled according to `chartType` (byDay, byWeek, byMonth, byWeekday, byYear, etc.).
- Multi-level axis labels are rendered as needed (e.g., year above week, month above day).
- Labels are thinned/deduplicated to avoid crowding.
- Visual group markers (e.g., lines for month/week boundaries) are drawn as appropriate.
- Axis rendering is generic and mode-driven, not hardcoded for specific types.
- Utility functions for date grouping: `getWeek()`, `getWeekStart()`, `getMonthStart()`, `getYearStart()`.
- Always deduplicate axis labels and avoid overlapping text.

---

## Data & Usage Patterns

- Accepts generic array of data objects: `{ date, value, [highValue], [lowValue] }`.
- `chartType` configures x-axis grouping/formatting only; bars are rendered from provided data.
- Data is automatically aggregated according to selected mode.
- **Multi-Chart Per-Chart Data Example**:
  
  ```js
  Barchart.createMultiChart({
    container: '#multiChart1',
    chartType: 'byDay',
    visibleWidth: 900,
    chartHeight: 180,
    barMinWidth: 6,
    scrollToEnd: true,
    charts: [
      {
        data: data700a,
        renderType: 'bar',
        title: 'Daily Values',
        yAxisLabel: 'Value',
        barColor: '#4a90d9'
      },
      {
        data: data700b,
        renderType: 'high-low',
        title: 'Value Range (same data as bars above)',
        yAxisLabel: 'Range',
        highLowColor: '#e74c3c',
        avgMarkerColor: '#fff'
      }
    ]
  });
  ```
  - Each chart in the `charts` array provides its own `data` array.
  - All `data` arrays must be aligned by x-axis key (e.g., date) and have the same length/order.
  - The x-axis is shared and synchronized across all charts.

- Data aggregation utility: `aggregates(data, mode)` converts plain data to grouped high-low-average format for any supported chartType.

---

## Implementation Guidance

- Use SVG namespace for all elements.
- Configuration-driven approach with sensible defaults.
- Event-driven interactions for tooltips (mouseenter/mouseleave).
- Conditional rendering based on `config.chartType` and `config.renderType`.
- Automatic data normalization and validation.
- Scale functions for y-axis (linear/log) and consistent bar positioning.
- Always document new modes and config options in this file, `README.md`, and `agents/instructions.md` (if present).

---

## Best Practices

- Normalize input data (date strings → Date objects).
- Filter out invalid data points early.
- Include proper margins and axis labels.
- Use responsive design for different screen sizes.
- Optimize x-axis labels to prevent crowding.
- Deduplicate labels by tracking processed items.
- Calculate bar dimensions dynamically.
- Handle edge cases: empty data, single point, equal min/max values.

---

## Common Tasks

- **Adding new chart types**: Update aggregation logic, implement grouping/value calculation, update x-axis rendering, add example, document.
- **Modifying axis labels**: Update x-axis rendering, consider multi-level labels, implement label thinning, use CSS classes.
- **Adding interactions**: Use event listeners for hover, update/create tooltip, consider touch events for mobile.
- **Styling updates**: Modify `styles.css`, use CSS classes for elements, maintain design consistency.

---

## Data Flow

1. Input data is normalized.
2. Data is validated and filtered.
3. Data is aggregated based on `chartType`.
4. Bars are rendered based on `renderType`.
5. Axis labels are generated based on `chartType`.
6. Interactive elements (tooltips) are attached.

---

## Testing

- Open `index.html` in browser to test changes.
- Verify all chart types render correctly.
- Test edge cases: empty data, single point, large datasets.
- Check tooltips display proper information.
- Ensure axis labels don't overlap.
- Verify high-low charts show correct ranges.
- Test responsive behavior on different screen sizes.

---

## File Organization

```text
barchart-v2/
├── /src/barchart.js       # Core library
├── /src/styles.css        # basic styling
├── /examples/index.html        # Examples and demos
├── /examples/styles.css        # Custom styling, potenially overwriting /src/styles.css for colors
├── README.md         # User documentation
└── .cursorrules      # This file - AI agent guidance
```

---

## Version Control

- Keep commits focused and descriptive.
- Document breaking changes in commit messages.
- Update README.md when adding features.
- Maintain backward compatibility when possible.

---

## Future Enhancements

- Additional aggregation modes (quarters, custom periods)
- Multiple series support
- Animation options
- Export to image/SVG
- Custom tooltip formatting
- Accessibility improvements (ARIA labels, keyboard navigation)
